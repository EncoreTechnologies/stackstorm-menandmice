version: '2.0'

menandmice.resolve_fqdn:
  description: >
    Create an fqdn from the M&M name and Zone info
  type: direct
  input:
    - connection
    - server
    - username
    - password
    - port
    - transport
    - session
    - dns_zone_ref
    - name

  output:
    fqdn: "{{ _.fqdn }}"

  tasks:
    main:
      action: std.noop
      on-success:
        - login: "{{ _.session == '' }}"
        - get_dns_zone: "{{ _.session != '' }}"

    login:
      action: menandmice.login
      input:
        connection: "{{ _.connection }}"
        server: "{{ _.server }}"
        username: "{{ _.username }}"
        password: "{{ _.password }}"
        port: "{{ _.port }}"
        transport: "{{ _.transport }}"
      publish:
        session: "{{ task('login').result.result.session }}"
      on-success:
        - get_dns_zone

    get_dns_zone:
      action: menandmice.get_dns_zone
      input:
        server: "{{ _.server }}"
        session: "{{ _.session }}"
        transport: "{{ _.transport }}"
        dns_zone_ref: "{{ _.dns_zone_ref }}"
      publish:
        fqdn: "{{ _.name + '.' + task('get_dns_zone').result.result.name }}"
